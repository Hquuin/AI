# 领域算法

## 分布式算法

### ZAB算法

ZAB协议全称：Zookeeper Atomic Broadcast(Zookeeper原子广播协议)

**ZAB协议定义：ZAB协议是为分布式协调服务Zookeeper专门设计的一种支持 *崩溃恢复*  和 *原子广播*  的协议** 



#### 消息广播

1.将数据都复制到Follwer中

2.等待Follwer回应Ack，最低**超过半数**即成功

3.当超过半数成功回应，则执行commit操作（<u>先提交自己，再发送commit给所有的Follwer</u>）



细节：

- leader收到客户端请求之后，<u>会将请求封装成一个事务</u>，并分配该事务一个**全局递增的唯一ID（ZXID）**，保证事务的顺序，按照事务ID进行先后排序然后处理
- Leader和Follwer之间有一个**消息队列**，用来<u>解耦它们之间的耦合，解除同步阻塞</u>
- zookeeper集群中<u>只能Leader服务器接收写请求</u>，即使Follwer服务器接收到客户端的请求也会转发到Leader服务器，保证所有进程能够有序的顺序执行
- 简化版2PC，不能解决单点问题（Leader崩溃问题）



#### 崩溃恢复

2个原则：

- 确保那些已经在Leader提交的事务最终会被所有服务器提交
- 确保丢弃那些只在Leader提出/复制，但没有提交的事务



**选举算法**：<u>能够确保提交已经被Leader提交的事务，同事丢弃已经被跳过的事务</u>

根据ZXID(事务ID)选举Leader，选举成功，开始数据同步



#### 数据同步

崩溃恢复后，在接受客户端请求之前，Leader服务器首先确认事务是否都已经被过半的Follwer提交（是否完成数据同步）。保证数据一致性。

等所有的Follwer服务器都成功同步之后，Leader会将这些服务器加入到可用列表中



#### ZXID生成

ZXID是一个64为的数字，低32位可以看作一个简单的递增的<u>计数器</u>（对新的客户端请求，Leader都会产生一个新的事务并对该计数器+1操作），高32位则代表Leader服务器上取出本地日志中最大事务Proposal的ZXID，并从该ZXID中解析出对应的epoch值，然后在对该值加一

<u>高 32 位代表了每代 Leader 的唯一性，低 32 代表了每代 Leader 中事务的唯一性。</u>同时，也能让 Follwer 通过高 32 位识别不同的 Leader。简化了数据恢复流程。

基于这样的策略：当 Follower 链接上 Leader 之后，Leader 服务器会根据自己服务器上最后被提交的 ZXID 和 Follower 上的 ZXID 进行比对，比对结果要么回滚，要么和 Leader 同步。